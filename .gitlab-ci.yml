stages:
  - build
  - test
  - deploy

services:
  - name: docker:dind
    command: ["--experimental"]

before_script:
  - apk --no-cache add git just

image: docker:git

variables:
  PLATFORMS: "linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6"

.matrix:
  parallel:
    matrix:
      - VERSION:
          - "2.18"
          - "latest"

build:
  artifacts:
    paths:
      - .cache
    expire_in: 1 hour
  extends:
    - .matrix
  stage: build
  script:
    - just build "${VERSION}" "${PLATFORMS}"
    - just run
    - docker stop selfoss
    # Upload internally for testing
    - >
      just
      USER="${CI_REGISTRY_USER}"
      PASSWORD="${CI_REGISTRY_PASSWORD}"
      REGISTRY="${CI_REGISTRY}"
      REPOSITORY="${CI_REGISTRY_IMAGE}"
      upload "${VERSION}" "${PLATFORMS}"

scan:
  dependencies: []
  image:
    name: aquasec/trivy
    entrypoint: [""]
  stage: test
  script:
    - just scan "${CI_REGISTRY_IMAGE}"

deploy:
  extends:
    - .matrix
  only:
    - master
  retry: 1
  stage: deploy
  script:
    - just upload "${VERSION}" "${PLATFORMS}"
